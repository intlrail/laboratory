/*!
 * World JS
 * Version 3.0.0
 *
 * https://github.com/anvoz/world-js
 * Copyright (c) 2013-2014 An Vo - anvo4888@gmail.com
 * Licensed under MIT (http://www.opensource.org/licenses/mit-license.php)
 */
define(function(a){"use strict";var b=a("./event"),c=a("./female"),d=a("./male"),e=a("./seed"),f=a("./tile"),g=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(function(){a(+new Date)},1e3/60)}}(),h=function(){var a=this;a.running=!1,a.stopCallback=function(){},a.width=640,a.height=360,a.padding=10,a.canvas={wrapper:!1,context:!1},a.sprite={src:"images/icons.png",image:!1},a.displayMode="full",a.totalSeeds=0,a.nextSeedId=1,a.maxSafeSeedsForDisplay=3e4,a.tickPerYear=60,a.speed=1,a.tickMod=0,a.distributedTicks=[];for(var e=0;e<a.tickPerYear-1;e++)a.distributedTicks.push(0);a.lastTickTime=0,a.fps=0,a.event=new b(a),a.Female=c,a.Male=d,a.tile=new f(a)};return h.prototype.init=function(a){var b=this,c=document.createElement("canvas"),d=document.getElementById(a),e=d.clientWidth||b.width,f=d.clientHeight||b.height;b.canvas.wrapper=d,b.width=c.width=e,b.height=c.height=f,d.appendChild(c),b.canvas.context=c.getContext("2d");var g=new Image;return g.src=b.sprite.src,b.sprite.image=g,b.tile.init(e,f),b},h.prototype.addSeed=function(a,b){b=b||{};var c=this,d=new a(b);c.totalSeeds++,d.world=c,d.id=c.nextSeedId++,d.age=b.age||0,d.tickCount=d.age>0?d.age*c.tickPerYear:d.tickCount;var e=c.getTickIndex();c.distributedTicks[e]++,d.tickIndex=e,d.tickMod=c.tickMod,d.tickCount+=(c.tickMod+d.tickCount+d.tickIndex)%d.actionInterval,d.stepCount=d.tickCount,d.moveUntilStep=d.moveUntilStep||d.tickCount+c.random(2,10)*d.jumpInterval;var f=c.getRandomPosition(d);return d.x=f.x,d.y=f.y,d.tileIndex=c.tile.getIndex(d),c.tile.set(d),c.event.trigger("seedAdded",{seed:d,mother:b.mother||void 0}),d},h.prototype.getTickIndex=function(){for(var a=this,b=a.distributedTicks,c=0,d=b[c],e=0,f=b.length;f>e;e++)b[e]<d&&(c=e,d=b[e]);return c},h.prototype.getRandomPosition=function(a,b){b=b||!1;var c=this,d=a.x===!1||b?c.random(c.padding,c.width-a.icon.width-c.padding):a.x,e=a.y===!1||b?c.random(c.padding,c.height-a.icon.height-c.padding):a.y;return{x:d,y:e}},h.prototype.removeSeed=function(a){var b=this;return b.totalSeeds--,b.event.trigger("seedRemoved",{seed:a}),a.relationSeed!==!1&&(a.relationSeed.relationSeed=!1,a.relationSeed=!1),b.tile.rem(a),b.distributedTicks[a.tickIndex]--,b},h.prototype.addSeeds=function(a,b){b=b||{};for(var c=this,d="undefined"!=typeof b.types?b.types:[e],f="undefined"!=typeof b.minAge?b.minAge:15,g="undefined"!=typeof b.maxAge?b.maxAge:20,h=0;a>h;h++){var i=c.random(f,g),j={x:!1,y:!1,age:i};if("undefined"!=typeof b.fromBorder){var k=["top","bottom","left","right"],l="random"===b.fromBorder?k[c.random(0,3)]:b.fromBorder;switch(l){case"top":j.y=c.random(0,c.padding);break;case"bottom":j.y=c.random(c.height-c.padding-1,c.height-1);break;case"left":j.x=c.random(0,c.padding);break;case"right":j.x=c.random(c.width-c.padding-1,c.width-1)}}c.addSeed(d[h%d.length],j)}return c},h.prototype.run=function(a){var b=this,c=b.canvas.context,d=b.sprite.image;b.tickMod=++b.tickMod%b.tickPerYear;var e=0===b.tickMod,f=b.totalSeeds<=b.maxSafeSeedsForDisplay||e;f&&c.clearRect(0,0,b.width,b.height);for(var h=b.tile.list,i=b.tile.maxDisplayedSeeds,j=b.speed,k=0,l=h.length;l>k;k++)for(var m=h[k],n=0,o=0,p=m.length;p>o;o++)if(m[o]){var q=m[o],r=q.tileIndex;if(q.tickMod==b.tickMod)continue;if(q.tickMod=b.tickMod,e&&q.age++,f&&i>n){switch(b.displayMode){case"full":q.draw(c,d);break;case"dot":q.draw(c,!1);break;case"none":}n++}q.tick(j);var s=b.tile.getIndex(q);s!==r&&(b.tile.rem(q),q.tileIndex=s,b.tile.set(q))}return e&&(b.event.trigger("yearPassed"),0===b.totalSeeds)?void(b.running=!1):(b.running?(b.fps=1e3/(a-b.lastTickTime),b.lastTickTime=a,g(function(){b.run.call(b)})):(b.stopCallback.call(b),b.stopCallback=function(){}),b)},h.prototype.start=function(){var a=this;return a.running=!0,a.run(),a},h.prototype.stop=function(a){var b=this;return b.running=!1,"function"==typeof a&&(b.stopCallback=a),b},h.prototype.random=function(a,b){return Math.floor(Math.random()*(b-a+1)+a)},h}),define(function(){"use strict";var a=function(a){var b=this;b.world=a,b.list=[],b.availableArrayIndexes=[],b.size=20,b.maxDisplayedSeeds=7,b.totalTiles=!1,b.tilesPerRow=!1,b.tilesPerCol=!1};return a.prototype.init=function(a,b){var c=this,d=c.size,e=Math.ceil(b/d),f=Math.ceil(a/d),g=e*f;c.tilesPerRow=e,c.tilesPerCol=f,c.totalTiles=g;for(var h=c.list,i=c.availableArrayIndexes,j=0;g>j;j++)h.push([]),i.push([])},a.prototype.getIndex=function(a){var b=this.size,c=Math.floor(a.x/b),d=Math.floor(a.y/b);return c+d*this.tilesPerCol},a.prototype.set=function(a){var b=this,c=a.tileIndex,d=b.list[c],e=b.availableArrayIndexes[c];e.length>0?(a.tileArrayIndex=e.pop(),d[a.tileArrayIndex]=a):(a.tileArrayIndex=d.length,d.push(a))},a.prototype.rem=function(a){var b=this,c=a.tileIndex,d=a.tileArrayIndex;b.list[c][d]=!1,b.availableArrayIndexes[c].push(d)},a}),define(function(){"use strict";var a=function(a){var b=this;b.world=a,b.list={yearPassed:{},seedAdded:{},seedRemoved:{}}};return a.prototype.add=function(a,b,c){this.list[a][b]=c},a.prototype.remove=function(a,b){delete this.list[a][b]},a.prototype.trigger=function(a,b){var c=this,d=c.world,e=c.list[a];for(var f in e)e.hasOwnProperty(f)&&e[f].call(d,b)},a}),define(function(){"use strict";var a=function(a){var b=this;b.world=!1,b.id=!1,b.tileIndex=!1,b.tickIndex=!1,b.tickMod=!1,b.age=a.age||0,b.x="undefined"==typeof a.x?!1:a.x,b.y="undefined"==typeof a.y?!1:a.y,b.icon=a.icon||{width:1,height:1},b.carrying=a.carrying||!1,b.relationSeed=a.relationSeed||!1,b.tickCount=a.tickCount||0,b.actionInterval=a.actionInterval||30,b.stepCount=b.tickCount,b.jumpInterval=20,b.moveUntilStep=a.moveUntilStep||0,b.ageToMoveAgain=0,b.isMoving=!1,b.moveTo=a.moveTo||!1};return a.prototype.draw=function(a,b){var c=this;if(b===!1||1===c.icon.width){var d=b!==!1?c.icon.width:1,e=b!==!1?c.icon.height:1;a.fillRect(c.x,c.y,d,e)}else{var f=c.age<=c.maxChildAge?c.icon.child:c.icon,g=c.jumpInterval,h=10,i=c.stepCount%g,j=h>i?i+1:h-i%h-1;if(a.drawImage(b,f.x,f.y,f.width,f.height,c.x,c.y-j,f.width,f.height),c.carrying!==!1&&"none"!==c.carrying){var k=c.carrying;a.drawImage(b,k.x,k.y,k.width,k.height,c.x+k.dx,c.y-j+k.dy,k.width,k.height)}}},a.prototype.getCarryingItem=function(a,b){var c=this,d=c.world;if("undefined"!=typeof d.items){var e=d.items,f=[];for(var g in e){var h=e[g];h.enabled===!0&&h.who===a&&h.when===b&&f.push(h.icon)}var i=f.length;if(1===i)return f[0];if(i>1)return f[d.random(0,i-1)]}return!1},a.prototype.move=function(a,b){var c=this,d=c.world,e=d.random;if(c.isMoving=!0,b)b.call(c);else if(c.stepCount>=c.moveUntilStep){if(0===c.ageToMoveAgain||c.ageToMoveAgain>c.age)return 0===c.ageToMoveAgain&&(c.ageToMoveAgain=c.age+e(2,c.age),c.carrying=!1),void(c.isMoving=!1);c.ageToMoveAgain=0,c.moveUntilStep=c.stepCount+e(2,10)*c.jumpInterval,c.carrying=!1}(c.moveTo===!1||c.moveTo.x===c.x&&c.moveTo.y===c.y)&&(c.moveTo=d.getRandomPosition(c,!0)),c.stepCount++,c.x<c.moveTo.x?c.x=Math.min(c.x+a,c.moveTo.x):c.x>c.moveTo.x&&(c.x=Math.max(c.x-a,0)),c.y<c.moveTo.y?c.y=Math.min(c.y+a,c.moveTo.y):c.y>c.moveTo.y&&(c.y=Math.max(c.y-a,0))},a.prototype.seek=function(a){var b=this,c=b.world.tile,d=[[0,0],[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]];a||(a=function(a){return a.id!=b.id});for(var e=c.tilesPerRow,f=c.tilesPerCol,g=0,h=d.length;h>g;g++){var i;if(0===g)i=b.tileIndex;else{var j=b.tileIndex%e+d[g][0],k=Math.floor(b.tileIndex/e)+d[g][1];if(!(j>=0&&e>j&&k>=0&&f>k))continue;i=j+k*e}for(var l=c.list[i],m=0,n=l.length;n>m;m++)if(l[m]&&b.id!=l[m].id){var o=l[m];if(a.call(b,o))return o}}return!1},a.prototype.tick=function(a){var b=this;b.tickCount++,b.move(a)},a.prototype.getChance=function(a){for(var b=this,c=b.chances[a],d=b.age,e=0,f=0,g=0,h=0;c[e]&&d>=c[e].range[0];){var i=c[e];f=i.range[0],g=i.from,h=(i.to-i.from)/(i.range[1]-i.range[0]),e++}return g+(d-f)*h},a}),define(function(a){"use strict";var b=a("./seed"),c=function(a){var c=this;a.icon={x:0,y:0,width:13,height:20,child:{x:26,y:0,width:11,height:10}},b.call(c,a),c.maxChildAge=15,c.chances=a.chances||{death:[{range:[1,20],from:.02,to:.01},{range:[20,60],from:.01,to:.02},{range:[60,80],from:.02,to:.05},{range:[80,100],from:.05,to:.9}],marriage:[{range:[15,30],from:.1,to:.5},{range:[30,50],from:.5,to:.1},{range:[50,80],from:.1,to:.01}]}};return c.prototype=Object.create(b.prototype),c.prototype.contructor=c,c.prototype.tick=function(a){var b=this,c=b.world;b.tickCount++;var d=b.actionInterval/a;if(b.tickCount%d===d-1){var e=b.getChance("death");if(e>0&&Math.random()<e)return void c.removeSeed(b);if(b.relationSeed===!1&&b.age>=b.chances.marriage[0].range[0]){var f=b.getChance("marriage");if(f>0){var g=Math.random();if(f>g){var h=b.seek(function(a){var b=this,c=b.world;return a instanceof c.Female&&a.relationSeed===!1&&a.age>=a.chances.childbirth[0].range[0]&&(a.age<=b.age||g*Math.ceil((a.age-b.age)/10)<f)});h!==!1&&(b.relationSeed=h,h.relationSeed=b,"undefined"==typeof h.totalChildren&&(h.totalChildren=0),h.ageLastBear=h.age+1,b.carrying=!1,h.carrying=!1)}}}}if(b.relationSeed!==!1){if(b.x===Math.max(0,b.relationSeed.x-10)&&b.y===b.relationSeed.y)return;b.move(a,function(){var a=this,b=a.relationSeed;a.moveTo.x=Math.max(a.world.padding,b.x-10),a.moveTo.y=b.y})}else b.move(a,!1);if(b.carrying===!1&&"undefined"!=typeof c.items)if(Math.random()<.2){if(b.age>b.maxChildAge){var i=b.relationSeed===!1?"man":"husband",j=b.isMoving?"moving":"standing";b.carrying=b.getCarryingItem(i,j)}}else b.carrying="none"},c}),define(function(a){"use strict";var b=a("./seed"),c=function(a){var c=this;a.icon={x:13,y:0,width:13,height:20,child:{x:26,y:10,width:11,height:10}},b.call(c,a),c.maxChildAge=15,c.totalChildren=void 0,c.ageLastBear=0,c.chances=a.chances||{death:[{range:[1,25],from:.02,to:.01},{range:[25,65],from:.01,to:.02},{range:[65,85],from:.02,to:.05},{range:[85,105],from:.05,to:.9}],childbirth:[{range:[15,25],from:.1,to:.25},{range:[25,50],from:.25,to:.1},{range:[50,70],from:.1,to:.001}]}};return c.prototype=Object.create(b.prototype),c.prototype.contructor=c,c.prototype.tick=function(a){var b=this,c=b.world;b.tickCount++;var d=b.actionInterval/a;if(b.tickCount%d===d-1){var e=b.age,f=b.getChance("death");if(f>0&&Math.random()<f)return void c.removeSeed(b);if(b.relationSeed!==!1&&e>=b.chances.childbirth[0].range[0]&&e>b.ageLastBear){var g=b.getChance("childbirth");if(g>0&&Math.random()<g){b.ageLastBear=e+1,b.totalChildren++;var h={x:b.x,y:Math.min(c.height-1-c.padding,b.y+Math.floor(b.icon.height/2)),mother:b};Math.random()<.5?c.addSeed(c.Male,h):c.addSeed(c.Female,h)}}}if(b.move(a,!1),b.carrying===!1&&"undefined"!=typeof c.items)if(Math.random()<.2){if(b.age>b.maxChildAge){var i=b.relationSeed===!1?"woman":"wife",j=b.isMoving?"moving":"standing";b.carrying=b.getCarryingItem(i,j)}}else b.carrying="none"},c});