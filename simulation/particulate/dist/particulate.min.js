!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?b(exports):"function"==typeof define&&define.amd?define(["exports"],b):b(a.Particulate=a.Particulate||{})}(this,function(a){"use strict";function b(a){return function(){var b=Object.create(a.prototype);return a.apply(b,arguments),b}}function c(a,c){a.create=b(a),a.prototype=Object.create(c.prototype),a.prototype.constructor=a}function d(a,b,c){return Math.min(Math.max(c,a),b)}function e(a,b,c){c=c||0,this.indices=new Uint16Array(a+c),this._count=a/b,this._itemSize=b,this._offset=c}function f(a,b,c,d){var f=b.length||arguments.length-1,g=a.length?a[0]:a,h=a.length?a[1]:a;e.call(this,f,3),this.setAngle(g,h),this.setIndices(b,c,d)}function g(a,b,c){var d=c.length||1;e.call(this,d,1,2),this.setAxis(a,b),this.setIndices(c)}function h(a,b,c){this.distance=c||0,this.friction=.05,this.bufferVec3=s.create(2),this.setOrigin(a),this.setNormal(b)}function i(a,b){this.friction=.05,this.bufferVec3=s.create(2),this.setBounds(a,b)}function j(a,b,c){var d=b.length||arguments.length-1,f=a.length?a[0]:a,g=a.length?a[1]:a;e.call(this,d,2),this.setDistance(f,g),this.setIndices(b,c)}function k(a,b,c,d){var f=d.length||1;e.call(this,f,1,3),this.bufferVec3=s.create(1),this.setPlane(a,b,c),this.setIndices(d)}function l(a,b){var c=b.length||1;e.call(this,c,1),this.bufferVec3=s.create(1),this.setPosition(a),this.setIndices(b)}function m(a,b){b=b||{},this.vector=new Float32Array(3),b.type&&(this.type=b.type),null!=a&&this.set(a)}function n(a){m.call(this,a)}function o(a,b){b=b||{},m.apply(this,arguments),this.intensity=b.intensity||.05,this.setRadius(b.radius||0)}function p(a,b){var c=a.indexOf(b);if(!(c<0))for(var d=a.length-1;d>=c;d--)a[d]===b&&a.splice(d,1)}function q(a,b){var c="number"==typeof a,d=c?3*a:a.length,e=d/3,f=c?d:a;this.positions=new Float32Array(f),this.positionsPrev=new Float32Array(f),this.accumulatedForces=new Float32Array(d),this.weights=new Float32Array(e),this.setWeights(1),this._iterations=b||1,this._count=e,this._globalConstraints=[],this._localConstraints=[],this._pinConstraints=[],this._forces=[]}function r(a,b,c,d,e,f){var g=b[a];b[a]+=g-c[a]+d[a]*e*f,c[a]=g}c(e,Object),e.prototype.setIndices=function(a){for(var b=this._offset,c=a.length?a:arguments,d=this.indices,e=0;e<c.length;e++)d[e+b]=c[e]},e.prototype.applyConstraint=function(a,b,c){},c(f,e),f.prototype.setAngle=function(a,b){b=null!=b?b:a,this.setMin(a),this.setMax(b)},f.prototype.setMin=function(a){this._min=this.clampAngle(a)},f.prototype._min=null,f.prototype.setMax=function(a){this._max=this.clampAngle(a)},f.prototype._max=null,f.prototype.clampAngle=function(a){var b=1e-7;return d(b,Math.PI-b,a)},f.ANGLE_OBTUSE=.75*Math.PI,f.prototype.applyConstraint=function(a,b,c){var d=this.indices,e=d[a],g=d[a+1],h=d[a+2],i=3*e,j=i+1,k=i+2,l=3*g,m=l+1,n=l+2,o=3*h,p=o+1,q=o+2,r=b[l]-b[i],s=b[m]-b[j],t=b[n]-b[k],u=b[o]-b[l],v=b[p]-b[m],w=b[q]-b[n],x=b[o]-b[i],y=b[p]-b[j],z=b[q]-b[k];if(!(x||y||z))return b[i]+=.1,b[m]+=.1,void(b[o]-=.1);var A=r*r+s*s+t*t,B=u*u+v*v+w*w,C=x*x+y*y+z*z,D=Math.sqrt(A),E=Math.sqrt(B),F=Math.sqrt(C),G=1/D,H=1/E,I=this._min,J=this._max,K=Math.acos(-r*G*u*H+-s*G*v*H+-t*G*w*H);if(!(K>I&&K<J)){var L=K<I?I:J,M=A+B-2*D*E*Math.cos(L),N=Math.sqrt(M),O=(F-N)/F*.5;if(b[i]+=x*O,b[j]+=y*O,b[k]+=z*O,b[o]-=x*O,b[p]-=y*O,b[q]-=z*O,!(L<f.ANGLE_OBTUSE)){var P=Math.acos((A+M-B)/(2*D*N)),Q=1/F,R=x*Q,S=y*Q,T=z*Q,U=R*r+S*s+T*t,V=R*U,W=S*U,X=T*U,Y=V-r,Z=W-s,$=X-t;if(!(Y||Z||$))return void(L<Math.PI&&(b[l]+=.1,b[m]+=.1,b[n]+=.1));var _=V*V+W*W+X*X,aa=Y*Y+Z*Z+$*$,ba=Math.sqrt(_),ca=Math.sqrt(aa),da=ba*Math.tan(P),ea=(ca-da)/ca;b[l]+=Y*ea,b[m]+=Z*ea,b[n]+=$*ea}}},c(g,e),g.prototype.setAxis=function(a,b){var c=this.indices;c[0]=a,c[1]=b},g.prototype.applyConstraint=function(a,b,c){var d=this.indices,e=d[0],f=d[a+2],g=d[1],h=3*e,i=h+1,j=h+2,k=3*f,l=k+1,m=k+2,n=3*g,o=n+1,p=n+2,q=b[k]-b[h],r=b[l]-b[i],s=b[m]-b[j],t=b[n]-b[h],u=b[o]-b[i],v=b[p]-b[j],w=t*t+u*u+v*v,x=Math.sqrt(w),y=1/x,z=t*y,A=u*y,B=v*y,C=z*q+A*r+B*s,D=z*C,E=A*C,F=B*C;b[k]=b[h]+D,b[l]=b[i]+E,b[m]=b[j]+F};var s={};s.create=function(a){a=a||1;var b="number"==typeof a;return new Float32Array(b?3*a:a)},s.set=function(a,b,c,d,e){var f=3*b,g=f+1,h=f+2;null==d&&(e=c[2],d=c[1],c=c[0]),a[f]=c,a[g]=d,a[h]=e},s.copy=function(a,b,c){var d=3*b,e=d+1,f=d+2;return c[0]=a[d],c[1]=a[e],c[2]=a[f],c},s.lengthSq=function(a,b){var c=3*b,d=c+1,e=c+2,f=a[c],g=a[d],h=a[e];return f*f+g*g+h*h},s.length=function(a,b){var c=3*b,d=c+1,e=c+2,f=a[c],g=a[d],h=a[e];return Math.sqrt(f*f+g*g+h*h)},s.distanceSq=function(a,b,c){var d=3*b,e=d+1,f=d+2,g=3*c,h=g+1,i=g+2,j=a[d]-a[g],k=a[e]-a[h],l=a[f]-a[i];return j*j+k*k+l*l},s.distance=function(a,b,c){var d=3*b,e=d+1,f=d+2,g=3*c,h=g+1,i=g+2,j=a[d]-a[g],k=a[e]-a[h],l=a[f]-a[i];return Math.sqrt(j*j+k*k+l*l)},s.normalize=function(a,b){var c=3*b,d=c+1,e=c+2,f=a[c],g=a[d],h=a[e],i=1/Math.sqrt(f*f+g*g+h*h);a[c]*=i,a[d]*=i,a[e]*=i},s.angle=function(a,b,c,d){var e=3*b,f=e+1,g=e+2,h=3*c,i=h+1,j=h+2,k=3*d,l=k+1,m=k+2,n=1/s.distance(a,c,b),o=1/s.distance(a,c,d),p=(a[e]-a[h])*n,q=(a[f]-a[i])*n,r=(a[g]-a[j])*n,t=(a[k]-a[h])*o,u=(a[l]-a[i])*o,v=(a[m]-a[j])*o,w=p*t+q*u+r*v;return Math.acos(w)},c(h,e),h.prototype._isGlobal=!0,h.prototype.setOrigin=function(a,b,c){s.set(this.bufferVec3,0,a,b,c)},h.prototype.setNormal=function(a,b,c){s.set(this.bufferVec3,1,a,b,c),s.normalize(this.bufferVec3,1)},h.prototype.applyConstraint=function(a,b,c){var d=this.friction,e=this.bufferVec3,f=a,g=f+1,h=f+2,i=b[f]-e[0],j=b[g]-e[1],k=b[h]-e[2],l=e[3],m=e[4],n=e[5],o=i*l+j*m+k*n;o>this.distance||(b[f]-=l*o,b[g]-=m*o,b[h]-=n*o,c[f]-=(c[f]-b[f])*d,c[g]-=(c[g]-b[g])*d,c[h]-=(c[h]-b[h])*d)},c(i,e),i.prototype._isGlobal=!0,i.prototype.setBounds=function(a,b){this.setMin(a),this.setMax(b)},i.prototype.setMin=function(a,b,c){s.set(this.bufferVec3,0,a,b,c)},i.prototype.setMax=function(a,b,c){s.set(this.bufferVec3,1,a,b,c)},i.prototype.applyConstraint=function(a,b,c){var e=this.friction,f=this.bufferVec3,g=a,h=g+1,i=g+2,j=d(f[0],f[3],b[g]),k=d(f[1],f[4],b[h]),l=d(f[2],f[5],b[i]),m=b[g]-j,n=b[h]-k,o=b[i]-l;b[g]=j,b[h]=k,b[i]=l,(m||n||o)&&(c[g]-=(c[g]-j)*e,c[h]-=(c[h]-k)*e,c[i]-=(c[i]-l)*e)},c(j,e),j.prototype.setDistance=function(a,b){this.setMin(a),this.setMax(null!=b?b:a)},j.prototype.setMin=function(a){this._min2=a*a},j.prototype._min2=null,j.prototype.setMax=function(a){this._max2=a*a},j.prototype._max2=null,j.prototype.applyConstraint=function(a,b,c){var d=this.indices,e=d[a],f=d[a+1],g=3*e,h=g+1,i=g+2,j=3*f,k=j+1,l=j+2,m=b[j]-b[g],n=b[k]-b[h],o=b[l]-b[i];m||n||o||(m=n=o=.1);var p=m*m+n*n+o*o,q=this._min2,r=this._max2;if(!(p<r&&p>q)){var s=p<q?q:r,t=s/(p+s),u=t-.5,v=t-.5;b[g]-=m*u,b[h]-=n*u,b[i]-=o*u,b[j]+=m*v,b[k]+=n*v,b[l]+=o*v}},c(k,e),k.prototype.setPlane=function(a,b,c){var d=this.indices;d[0]=a,d[1]=b,d[2]=c},k.prototype._calculateNormal=function(a,b){var c=this.bufferVec3,d=this.indices,e=d[0],f=d[1],g=d[2],h=3*e,i=h+1,j=h+2,k=3*f,l=k+1,m=k+2,n=3*g,o=n+1,p=n+2,q=b[h]-b[k],r=b[i]-b[l],s=b[j]-b[m],t=b[n]-b[k],u=b[o]-b[l],v=b[p]-b[m],w=r*v-s*u,x=s*t-q*v,y=q*u-r*t,z=w*w+x*x+y*y;if(!z)return b[h]+=.1,b[l]+=.1,b[n]-=.1,void(this._hasNormal=!1);var A=1/Math.sqrt(z);c[0]=w*A,c[1]=x*A,c[2]=y*A,this._hasNormal=!0},k.prototype._hasNormal=!1,k.prototype.applyConstraint=function(a,b,c){var d=this.bufferVec3,e=this.indices,f=e[1],g=e[a+3],h=3*f,i=h+1,j=h+2,k=3*g,l=k+1,m=k+2;if(0===a&&this._calculateNormal(a,b),this._hasNormal){var n=d[0],o=d[1],p=d[2],q=b[k]-b[h],r=b[l]-b[i],s=b[m]-b[j],t=q*n+r*o+s*p;b[k]-=n*t,b[l]-=o*t,b[m]-=p*t}},c(l,e),l.prototype.setPosition=function(a,b,c){s.set(this.bufferVec3,0,a,b,c)},l.prototype.applyConstraint=function(a,b,c){var d=this.bufferVec3,e=this.indices[a],f=3*e,g=f+1,h=f+2;b[f]=c[f]=d[0],b[g]=c[g]=d[1],b[h]=c[h]=d[2]},c(m,Object),m.ATTRACTOR=0,m.REPULSOR=1,m.ATTRACTOR_REPULSOR=2,m.prototype.type=m.ATTRACTOR,m.prototype.set=function(a,b,c){s.set(this.vector,0,a,b,c)},m.prototype.applyForce=function(a,b,c,d){},c(n,m),n.prototype.applyForce=function(a,b,c,d){var e=this.vector;b[a]+=e[0],b[a+1]+=e[1],b[a+2]+=e[2]};var t=m.ATTRACTOR,u=m.REPULSOR,v=m.ATTRACTOR_REPULSOR;c(o,m),o.prototype.setRadius=function(a){this._radius2=a*a},o.prototype._radius2=null,o.prototype.applyForce=function(a,b,c,d){var e,f,g=this.vector,h=a+1,i=a+2,j=c[a]-g[0],k=c[h]-g[1],l=c[i]-g[2],m=j*j+k*k+l*l,n=m-this._radius2;switch(this.type){case t:e=m>0&&n>0;break;case u:e=m>0&&n<0;break;case v:e=j||k||l}e&&(f=n/m*this.intensity,b[a]-=j*f,b[h]-=k*f,b[i]-=l*f)},c(q,Object),q.prototype.setPosition=function(a,b,c,d){s.set(this.positions,a,b,c,d),s.set(this.positionsPrev,a,b,c,d)},q.prototype.getPosition=function(a,b){return s.copy(this.positions,a,b)},q.prototype.getDistance=function(a,b){return s.distance(this.positions,a,b)},q.prototype.getAngle=function(a,b,c){return s.angle(this.positions,a,b,c)},q.prototype.setWeight=function(a,b){this.weights[a]=b},q.prototype.setWeights=function(a){for(var b=this.weights,c=0,d=b.length;c<d;c++)b[c]=a},q.prototype.each=function(a,b){b=b||this;for(var c=0,d=this._count;c<d;c++)a.call(b,c,this)},q.prototype.perturb=function(a){for(var b,c=this.positions,d=this.positionsPrev,e=0,f=c.length;e<f;e++)b=Math.random()*a,c[e]+=b,d[e]+=b},q.prototype.integrate=function(a){for(var b,c,d=a*a,e=this.positions,f=this.positionsPrev,g=this.accumulatedForces,h=this.weights,i=0,j=this._count;i<j;i++)c=h[i],b=3*i,r(b,e,f,g,c,d),r(b+1,e,f,g,c,d),r(b+2,e,f,g,c,d)},q.prototype._getConstraintBuffer=function(a){return a._isGlobal?this._globalConstraints:this._localConstraints},q.prototype.addConstraint=function(a){this._getConstraintBuffer(a).push(a)},q.prototype.removeConstraint=function(a){p(this._getConstraintBuffer(a),a)},q.prototype.addPinConstraint=function(a){this._pinConstraints.push(a)},q.prototype.removePinConstraint=function(a){p(this._pinConstraints,a)},q.prototype.satisfyConstraints=function(){for(var a=this._iterations,b=this._globalConstraints,c=this._localConstraints,d=this._pinConstraints,e=this._count,f=3,g=0;g<a;g++)this.satisfyConstraintGroup(b,e,f),this.satisfyConstraintGroup(c),d.length&&this.satisfyConstraintGroup(d)},q.prototype.satisfyConstraintGroup=function(a,b,c){for(var d,e=this.positions,f=this.positionsPrev,g=!b,h=0,i=a.length;h<i;h++){d=a[h],g&&(b=d._count,c=d._itemSize);for(var j=0;j<b;j++)d.applyConstraint(j*c,e,f)}},q.prototype.addForce=function(a){this._forces.push(a)},q.prototype.removeForce=function(a){p(this._forces,a)},q.prototype.accumulateForces=function(a){for(var b,c=this._forces,d=this.accumulatedForces,e=this.positions,f=this.positionsPrev,g=0,h=this._count;g<h;g++){b=3*g,d[b]=d[b+1]=d[b+2]=0;for(var i=0,j=c.length;i<j;i++)c[i].applyForce(b,d,e,f)}},q.prototype.tick=function(a){this.accumulateForces(a),this.integrate(a),this.satisfyConstraints()};var w="0.3.3";a.VERSION=w,a.AngleConstraint=f,a.AxisConstraint=g,a.BoundingPlaneConstraint=h,a.BoxConstraint=i,a.Constraint=e,a.DistanceConstraint=j,a.PlaneConstraint=k,a.PointConstraint=l,a.DirectionalForce=n,a.Force=m,a.PointForce=o,a.Vec3=s,a.ParticleSystem=q,a.ctor=b,a.inherit=c,Object.defineProperty(a,"__esModule",{value:!0})});